@model List<saavor.Shared.ViewModel.KitchenOrdersReportVm>
@{
    ViewData["Title"] = "Order Reports";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<!--   Big container   -->
<div class="container-fluid">

    <div class="row mt-4 mb-4">
        <div class="col-sm-12">
            @using (Html.BeginForm("managereports", "kitchendashboard"))
            {
                <input type="button" id="btnExport" class="float-right color-theme export--report" value="Export" />
                <div id="datepicker" class="input-group date  mb-4 reports--date" data-date-format="mm-dd-yyyy" style="width:200px">
                    <input id="searchDate" class="form-control reports--datepicker bg-dark" name="search" value="@TempData["CalendarDate"]" type="text" readonly style="border-color: #343a40" />
                    <span class="input-group-addon">
                        <i class="glyphicon glyphicon-calendar"></i>
                        <span class="material-icons material-icon--date">
                            calendar_today
                        </span>
                    </span>
                </div>
                <button class="btn color-theme color-white hide" type="submit" id="button-search_orders">
                </button>

            }

            <div class="table-responsive mt-5 pb-4 bg-white">
                <table class="table table-bordered manage_report--table" id="dataTable" width="100%" cellspacing="0">
                    <thead>
                        <tr>
                            <th width="10%">Order ID</th>
                            <th width="15%">Delivery/Pickup Date</th>
                            <th width="25%">Name & Address</th>
                            <th width="43%">Dishes Ordered & Customization</th>
                            <th width="5%">Quantity</th>
                        </tr>
                    </thead>
                    <tbody>
                        @{
                            var i = 1;
                        }
                        @if (Model != null && Model.Count > 0)
                        {
                            @foreach (var item in Model)
                            {
                                <tr>

                                    <td>@item.OrderId </td>
                                    <td>
                                        <span>@item.OrderStatus</span>
                                        <span>@item.OrderDate</span>
                                    </td>
                                    <td>
                                        <span>@item.UserName</span>
                                        <span>@item.AddressLine</span>
                                    </td>

                                    @if (item.OrderDishes != null && item.OrderDishes.Count > 0)
                                    {
                                        <td>
                                            @foreach (var dishe in item.OrderDishes)
                                            {
                                                <span>
                                                    &#9679;
                                                    @dishe.DishName
                                                </span>
                                            }
                                        </td>
                                        <td>

                                            @foreach (var dishe in item.OrderDishes)
                                            {
                                                <span>@dishe.Quantity</span>
                                            }
                                        </td>
                                    }
                                    else
                                    {
                                        <td></td>
                                        <td></td>
                                    }



                                </tr>
                                i++;
                            }

                        }
                        else
                        {
                            <tr>
                                <td colspan="4">No order found!</td>
                            </tr>
                        }
                    </tbody>
                </table>
                <div id="pagingDiv" class="float-right pr-3">@Html.Raw(ViewBag.Paging)</div>
            </div>
        </div>
    </div>
</div> <!--  big container -->
<div class="loading_container_overlay hide"></div>
<div class="loader_container hide">
    <div class="rainbow">
        <img src="/images/logo.png" alt="">
    </div>
</div>
<div id="export" class="hide"></div>
<div id="editor"></div>
@section Scripts {
    @{await Html.RenderPartialAsync("_ValidationScriptsPartial");}

    <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-datepicker/1.3.0/css/datepicker.css" rel="stylesheet" type="text/css" />
    <script src="~/js/sources/bootstrap_v3.2.0.min.js"></script>
    <script src="~/js/sources/bootstrap-datepicker_1.3.0.js"></script>
    <script src="~/js/sources/jspdf_1.5.3.min.js"></script>
    <script src="~/js/sources/jspdf.plugin.autotable_v3.5.6.min.js"></script>

    <script>

        $(function () {
            $("#datepicker").datepicker({
                autoclose: true,
                todayHighlight: true,
            });
        });
        $("#datepicker").datepicker().on("changeDate", function (e) {
            setTimeout(function () {
                $("#button-search_orders").click();
            }, 300);
        });

        $("body").on("click", "#btnExport", function () {
            showLoading()
            $.ajax({
                type: "POST",
                url: "/KitchenDashboard/GetExportOrders",
                data: { search: $("#searchDate").val() },
                dataType: "html",
                success: function (data) {
                    $("#export").html(data);
                    setTimeout(function () {
                        generatePDF();
                        hideLoading()
                    }, 300);
                },
                failure: function (response) { hideLoading() },
                error: function (response) { hideLoading() }
            });


        });
        function showLoading() {
            $(".loading_container_overlay,.loader_container").addClass("show").removeClass("hide");
        }
        function hideLoading() {
            $(".loading_container_overlay,.loader_container").addClass("hide").removeClass("show");
        }
        function generatePDF() {
            var doc = new jsPDF('p', 'pt', 'letter');
            var htmlstring = '';
            var tempVarToCheckPageHeight = 0;
            var pageHeight = 0;
            pageHeight = doc.internal.pageSize.height;
            specialElementHandlers = {
                // element with id of "bypass" - jQuery style selector
                '#bypassme': function (element, renderer) {
                    // true = "handled elsewhere, bypass text extraction"
                    return true
                }
            };
            margins = {
                top: 150,
                bottom: 60,
                left: 40,
                right: 40,
                width: 600
            };
            var y = 20;
            doc.setLineWidth(2);
            doc.text(40, y = y + 30, "Saavor - " + $(".header--kitchen_name").text() + " - " + $(".reports--datepicker").val() + "");
            doc.autoTable({
                html: '#dataTableExportToPdf',
                startY: 70,
                theme: 'grid',
                columnStyles: {
                    0: {
                        cellWidth: 80,
                    },
                    1: {
                        cellWidth: 120,
                    },
                    2: {
                        cellWidth: 100,
                    },
                    3: {
                        cellWidth: 180,
                    },
                    4: {
                        cellWidth: 80,
                    }
                },
                styles: {
                    mincellheight: 40
                }
            })
            doc.save("Order-" + $(".header--kitchen_name").text().replace(/ /g, "_") + "-" + $(".reports--datepicker").val() + ".pdf");
        }
    </script>
}